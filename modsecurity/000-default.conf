<VirtualHost *:80>
    # Configure ServerAdmin and ServerName
    ServerName  localhost
    ServerAdmin webmaster@localhost

    Include /etc/apache2/locationmatch/location_match.modsecurity
	
    # Configure main document root
    DocumentRoot ${DOCUMENT_ROOT}

    # Set basic settings for document root
    <Directory ${WEBHOME}>
        AllowOverride All
        Require all granted
        Options -Indexes +FollowSymLinks +MultiViews
        DirectoryIndex index.html index.htm index.php
    </Directory>

    # Set the Timeout
    Timeout ${PHP_MAX_EXECUTION_TIME}
    ProxyTimeout ${PHP_MAX_EXECUTION_TIME}

    # Healthchecks: Set /ping to be the healhcheck URL
    ProxyPass "/ping" "unix:${PHPFPM_SOCK_PATH}|fcgi://localhost/"
    ProxyPassReverse "/ping" "unix:${PHPFPM_SOCK_PATH}|fcgi://localhost/"

    # For any files that match PHP, pass it to PHP-FPM for processing
    <FilesMatch "\.php$">
        ProxyFCGIBackendType GENERIC
        SetHandler "proxy:unix:${PHPFPM_SOCK_PATH}|fcgi://localhost/"
    </FilesMatch>

    <IfModule remoteip_module>
        RemoteIPInternalProxy 10.42.0.0/16
        RemoteIPHeader X-Real-IP
    </IfModule>

    # Configure Log Settings
    <IfModule log_config_module>
        LogLevel  error
        ErrorLog  /var/log/apache2/error.log
        SetEnvIf  Request_URI "\.(css|js|jpe?g|png|gif|ico|cur|heic|webp|tiff?|mp3|m4a|aac|ogg|midi?|wav|mp4|mov|webm|mpe?g|avi|ogv|flv|wmv|svgz?|ttf|ttc|otf|eot|woff2?)(\.map)?$" nolog
        CustomLog /var/log/apache2/access.log combined env=!nolog
    </IfModule>
</VirtualHost>
